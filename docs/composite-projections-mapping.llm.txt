# Composite Projections Parameter Mapping

Domain: d3-composite-projections to atlas-composer parameter mapping
Purpose: Documents the correspondences between d3-composite-projections defaults and atlas-composer custom composite configurations

## Overview

The d3-composite-projections library provides pre-built composite projections for France, Portugal, and Spain.
Atlas-composer's custom composite projection system (composite-custom mode) allows users to replicate these projections
with full customization capability.

This document maps the default parameters from d3-composite-projections to atlas-composer's configuration format.

## Parameter Correspondence

### d3-composite-projections Structure
Each composite projection in d3-composite-projections has:
1. A main projection (e.g., europe, iberianPeninsule)
2. Multiple territory projections (e.g., guyane, madeira, canaryIslands)
3. Each projection has:
   - Projection type (conicConformal, mercator, etc.)
   - Center coordinates [longitude, latitude]
   - Scale multipliers (relative to main projection scale)
   - Translate offsets (in normalized coordinates, multiplied by k)
   - Clip extents (bounding boxes in normalized coordinates)

### Atlas-composer Configuration Format
Atlas-composer uses CompositeProjectionDefaults interface:
```typescript
interface CompositeProjectionDefaults {
  territoryProjections: Record<string, string>      // e.g., { 'FR-GP': 'mercator' }
  territoryTranslations: Record<string, {x, y}>     // pixel offsets
  territoryScales: Record<string, number>           // scale multipliers
}
```

## Mapping Formulas

### Scale Multiplier
**d3 → atlas-composer**: Direct copy
- d3: `projection.scale(_ * multiplier)` (line XX in source)
- atlas-composer: `territoryScales[code] = multiplier`
- Example: France Martinique = 1.6 in both

### Translation/Offset
**d3 → atlas-composer**: Requires pixel conversion
- d3: `projection.translate([x + offset_x * k, y + offset_y * k])`
  - offset_x, offset_y are normalized coordinates (fraction of scale k)
  - k = main projection scale (e.g., 2700 for France)
- atlas-composer: `territoryTranslations[code] = { x: pixels_x, y: pixels_y }`
  - pixels_x, pixels_y are absolute pixel offsets

**Conversion formula**:
```
atlas_offset_x = d3_offset_x * reference_scale
atlas_offset_y = d3_offset_y * reference_scale
```

Where reference_scale is the default scale from d3-composite-projections:
- France: 2700
- Portugal: 4200
- Spain: 2700

**Note**: The d3 translate values are relative to the viewport center and scale-dependent.
Atlas-composer offsets are stored in the territory.rendering.offset field in the JSON config,
which are then copied to territoryTranslations during initialization.

**Territory Dragging**: The useTerritoryCursor composable handles mouse-based territory repositioning by applying dynamic scaling based on atlas reference scale:
`scaling_factor = base_composite_width / reference_scale`. This ensures proper 1:1 cursor-to-territory movement responsiveness across different atlases:
- France (reference scale 2700): scaling factor ≈ 0.296
- Portugal (reference scale 4200): scaling factor ≈ 0.190  
- Equal-members like EU (reference scale 200): scaling factor = 4.0

### Projection Type
**d3 → atlas-composer**: Direct string mapping
- d3: Uses d3-geo projection constructors (conicConformal(), mercator())
- atlas-composer: Uses string identifiers ('conic-conformal', 'mercator')
- Mapping is handled by ProjectionFactory

## France (conicConformalFrance)

### d3-composite-projections Defaults
Reference: node_modules/d3-composite-projections/src/conicConformalFrance.js

**Main projection (europe)**:
- Type: conicConformal
- Rotation: [-3, -46.2]
- Parallels: [0, 60]
- Default scale: 2700
- Translate offset (d3): [0, 0] (no offset from viewport center)
- Atlas-composer offset: [0, 0] pixels (mainland is centered)
- ClipExtent (normalized): {x1: -0.0996, y1: -0.0908, x2: 0.0967, y2: 0.0864}
  - This defines the visible area and prevents Brittany from being cropped

**Territory projections and scale multipliers**:
| d3 Variable Name  | Atlas Code | Projection Type | Center (lon, lat)      | Scale Multiplier | d3 Translate Offset (normalized) |
|-------------------|------------|-----------------|------------------------|------------------|-----------------------------------|
| europe            | FR-MET     | conicConformal  | (implicit via rotate)  | 1.0              | [0, 0]                           |
| guyane            | FR-GF      | mercator        | [-53.2, 3.9]          | 0.6              | [-0.12, 0.0575]                  |
| martinique        | FR-MQ      | mercator        | [-61.03, 14.67]       | 1.6              | [-0.12, 0.013]                   |
| guadeloupe        | FR-GP      | mercator        | [-61.46, 16.14]       | 1.4              | [-0.12, -0.014]                  |
| saintBarthelemy   | FR-MF      | mercator        | [-62.85, 17.92]       | 5.0              | [-0.12, -0.044]                  |
| stPierreMiquelon  | FR-PM      | mercator        | [-56.23, 46.93]       | 1.3              | [-0.12, -0.065]                  |
| mayotte           | FR-YT      | mercator        | [45.16, -12.8]        | 1.6              | [0.117, -0.064]                  |
| reunion           | FR-RE      | mercator        | [55.52, -21.13]       | 1.2              | [0.116, -0.0355]                 |
| nouvelleCaledonie | FR-NC      | mercator        | [165.8, -21.07]       | 0.3              | [0.116, -0.0048]                 |
| wallisFutuna      | FR-WF      | mercator        | [-178.1, -14.3]       | 2.7              | [0.116, 0.022]                   |
| polynesie         | FR-PF      | mercator        | [-150.55, -17.11]     | 0.5              | [0.115, 0.075]                   |
| polynesie2        | FR-PF-2    | mercator        | [-150.55, -17.11]     | 0.06             | [0.11, 0.045]                    |

**Pixel offset calculation** (reference_scale = 2700):
| Atlas Code | d3 Offset (normalized) | Pixel Offset (offset * 2700) |
|------------|------------------------|------------------------------|
| FR-GF      | [-0.12, 0.0575]       | [-324, 155.25] ≈ [-324, 155] |
| FR-MQ      | [-0.12, 0.013]        | [-324, 35.1] ≈ [-324, 35]    |
| FR-GP      | [-0.12, -0.014]       | [-324, -37.8] ≈ [-324, -38]  |
| FR-MF      | [-0.12, -0.044]       | [-324, -118.8] ≈ [-324, -119]|
| FR-PM      | [-0.12, -0.065]       | [-324, -175.5] ≈ [-324, -176]|
| FR-YT      | [0.117, -0.064]       | [315.9, -172.8] ≈ [316, -173]|
| FR-RE      | [0.116, -0.0355]      | [313.2, -95.85] ≈ [313, -96] |
| FR-NC      | [0.116, -0.0048]      | [313.2, -12.96] ≈ [313, -13] |
| FR-WF      | [0.116, 0.022]        | [313.2, 59.4] ≈ [313, 59]    |
| FR-PF      | [0.115, 0.075]        | [310.5, 202.5] ≈ [311, 203]  |
| FR-PF-2    | [0.11, 0.045]         | [297, 121.5] ≈ [297, 122]    |

### Current atlas-composer Configuration
Reference: configs/france.json (territory.rendering fields)

The france.json already has these offsets defined, but they should match the d3-composite-projections values.
Let me verify against actual config:

| Atlas Code | Current Offset | Expected (from d3) | Match? |
|------------|----------------|-------------------|---------|
| FR-GF      | [-324, 155]    | [-324, 155]       | ✓       |
| FR-MQ      | [-324, 35]     | [-324, 35]        | ✓       |
| FR-GP      | [-324, -38]    | [-324, -38]       | ✓       |
| FR-MF      | [-324, -119]   | [-324, -119]      | ✓       |
| FR-PM      | [-324, -176]   | [-324, -176]      | ✓       |
| FR-YT      | [316, -173]    | [316, -173]       | ✓       |
| FR-RE      | [313, -96]     | [313, -96]        | ✓       |
| FR-NC      | [313, -13]     | [313, -13]        | ✓       |
| FR-WF      | [313, 59]      | [313, 59]         | ✓       |
| FR-PF      | [311, 203]     | [311, 203]        | ✓       |
| FR-PF-2    | [297, 122]     | [297, 122]        | ✓       |

Scale multipliers (baseScaleMultiplier):
| Atlas Code | Current Scale | Expected (from d3) | Match? |
|------------|---------------|-------------------|---------|
| FR-GF      | 0.6           | 0.6               | ✓       |
| FR-MQ      | 1.6           | 1.6               | ✓       |
| FR-GP      | 1.4           | 1.4               | ✓       |
| FR-MF      | 2.5           | 5.0               | ✗ MISMATCH |
| FR-PM      | 1.3           | 1.3               | ✓       |
| FR-YT      | 1.6           | 1.6               | ✓       |
| FR-RE      | 1.2           | 1.2               | ✓       |
| FR-NC      | 0.3           | 0.3               | ✓       |
| FR-WF      | 2.7           | 2.7               | ✓       |
| FR-PF      | 0.5           | 0.5               | ✓       |
| FR-PF-2    | 0.06          | 0.06              | ✓       |

**Issue found**: FR-MF (Saint-Martin) has scale 2.5 but should be 5.0

## Portugal (conicConformalPortugal)

### d3-composite-projections Defaults
Reference: node_modules/d3-composite-projections/src/conicConformalPortugal.js

**Main projection (iberianPeninsule)**:
- Type: conicConformal
- Rotation: [10, -39.3]
- Parallels: [0, 60]
- Default scale: 4200

**Territory projections and scale multipliers**:
| d3 Variable Name   | Atlas Code | Projection Type | Center (lon, lat)    | Scale Multiplier | d3 Translate Offset (normalized) |
|--------------------|------------|-----------------|----------------------|------------------|-----------------------------------|
| iberianPeninsule   | PT-CONT    | conicConformal  | (implicit via rotate)| 1.0              | [0, 0]                           |
| madeira            | PT-20      | conicConformal  | [-16.9, 32.75]      | 1.0              | [-0.0265, 0.025]                 |
| azores             | PT-30      | conicConformal  | [-28, 38.5]         | 0.6              | [-0.045, -0.02]                  |

**Pixel offset calculation** (reference_scale = 4200):
| Atlas Code | d3 Offset (normalized) | Pixel Offset (offset * 4200) |
|------------|------------------------|------------------------------|
| PT-20      | [-0.0265, 0.025]      | [-111.3, 105] ≈ [-111, 105]  |
| PT-30      | [-0.045, -0.02]       | [-189, -84] ≈ [-189, -84]    |

### Current atlas-composer Configuration
Reference: configs/portugal.json

| Atlas Code | Current Offset | Expected (from d3) | Match? |
|------------|----------------|-------------------|---------|
| PT-20      | [400, -200]    | [-111, 105]       | ✗ MAJOR MISMATCH |
| PT-30      | [-400, -100]   | [-189, -84]       | ✗ MAJOR MISMATCH |

Scale multipliers (baseScaleMultiplier):
| Atlas Code | Current Scale | Expected (from d3) | Match? |
|------------|---------------|-------------------|---------|
| PT-20      | 1.0           | 1.0               | ✓       |
| PT-30      | 1.0           | 0.6               | ✗ MISMATCH |

**Issues found**:
1. PT-20 (Madeira): Wrong offset entirely
2. PT-30 (Azores): Wrong offset and wrong scale

## Spain (conicConformalSpain)

### d3-composite-projections Defaults
Reference: node_modules/d3-composite-projections/src/conicConformalSpain.js

**Main projection (iberianPeninsule)**:
- Type: conicConformal
- Rotation: [5, -38.6]
- Parallels: [0, 60]
- Default scale: 2700

**Territory projections and scale multipliers**:
| d3 Variable Name   | Atlas Code | Projection Type | Center (lon, lat)    | Scale Multiplier | d3 Translate Offset (normalized) |
|--------------------|------------|-----------------|----------------------|------------------|-----------------------------------|
| iberianPeninsule   | ES-CONT    | conicConformal  | (implicit via rotate)| 1.0              | [0, 0]                           |
| canaryIslands      | ES-CN      | conicConformal  | (uses same rotate)  | 1.0              | [0.1, -0.094]                    |

**Pixel offset calculation** (reference_scale = 2700):
| Atlas Code | d3 Offset (normalized) | Pixel Offset (offset * 2700) |
|------------|------------------------|------------------------------|
| ES-CN      | [0.1, -0.094]         | [270, -253.8] ≈ [270, -254]  |

### Current atlas-composer Configuration
Reference: configs/spain.json

| Atlas Code | Current Offset | Expected (from d3) | Match? |
|------------|----------------|-------------------|---------|
| ES-CN      | [-400, 250]    | [270, -254]       | ✗ MAJOR MISMATCH |

Scale multipliers (baseScaleMultiplier):
| Atlas Code | Current Scale | Expected (from d3) | Match? |
|------------|---------------|-------------------|---------|
| ES-CN      | 2.0           | 1.0               | ✗ MISMATCH |

**Issues found**:
1. ES-CN (Canary Islands): Wrong offset entirely and wrong scale

Note: Spain also has ES-IB (Balearic Islands) which is NOT in d3-composite-projections

## Projection Type Mapping

d3-composite-projections uses D3 projection constructors, atlas-composer uses string identifiers:
| d3 Constructor      | Atlas String ID     |
|---------------------|---------------------|
| conicConformal()    | 'conic-conformal'   |
| mercator()          | 'mercator'          |

## Summary of Mismatches

### France
- FR-MF (Saint-Martin): Scale should be 5.0 (currently 2.5)

### Portugal
- PT-20 (Madeira): Offset should be [-111, 105] (currently [400, -200])
- PT-30 (Azores): Offset should be [-189, -84] (currently [-400, -100]), scale should be 0.6 (currently 1.0)

### Spain
- ES-CN (Canary Islands): Offset should be [270, -254] (currently [-400, 250]), scale should be 1.0 (currently 2.0)
- Note: Spain atlas also has ES-IB (Balearic Islands) which doesn't exist in d3-composite-projections

## Implementation Notes

1. **Mainland territories**: Don't need entries in defaultCompositeConfig (they use offset [0,0] and scale 1.0 by default)

2. **Missing territories**: Some territories in atlas configs don't exist in d3-composite-projections:
   - France: TAAF (FR-TF) - not in d3-composite-projections
   - Spain: Balearic Islands (ES-IB) - not in d3-composite-projections

3. **Projection type**: Most overseas territories in d3-composite-projections use mercator, except:
   - Portugal: All use conicConformal
   - Spain: Canary Islands uses conicConformal

4. **Adding defaultCompositeConfig**: The JSON config files currently don't have a defaultCompositeConfig field.
   This needs to be added to properly initialize the composite-custom mode with d3-equivalent defaults.

5. **Coordinate system**: d3 uses normalized coordinates (fraction of scale), atlas-composer uses pixel offsets.
   The conversion factor is the reference_scale from d3-composite-projections.

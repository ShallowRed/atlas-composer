# Syst√®me d'export de projection

## Vue d'ensemble

Le syst√®me d'export de projection permet de convertir une configuration visuelle (sliders de position et d'√©chelle) en code TypeScript r√©utilisable qui g√©n√®re une projection composite d3 personnalis√©e.

## Architecture

### 1. Utilitaires (`utils/projectionExporter.ts`)

#### `clientParamsToProjectionConfig()`

Convertit les param√®tres des sliders en configuration de projection.

**Entr√©es :**
- `clientTranslations`: `Record<string, { x: number, y: number }>` - Positions (-15 √† +15, -10 √† +10)
- `clientScales`: `Record<string, number>` - √âchelles (0.5 √† 2.0)
- `baseProjectionType`: `'conic-conformal' | 'albers'` - Type de projection de base

**Sortie :**
```typescript
interface CompositeProjectionConfig {
  baseProjection: 'conic-conformal' | 'albers'
  baseRotate: [number, number]
  baseParallels?: [number, number]
  territories: TerritoryProjectionParams[]
}
```

**Logique de conversion :**
```typescript
// Translation UI ‚Üí Coefficient de projection
const translateXCoeff = translation.x * 0.008
const translateYCoeff = translation.y * 0.008

// Dans la projection finale :
projection.translate([
  x + translateXCoeff * k, // k = scale de base
  y + translateYCoeff * k
])
```

#### `createCustomCompositeProjection()`

Cr√©e une instance de projection fonctionnelle √† partir de la configuration.

**Retour :** Une fonction factory `() => GeoProjection` qui :
1. Cr√©e une projection de base (conic conformal ou albers)
2. Cr√©e des projections Mercator pour chaque territoire
3. Impl√©mente le multiplex stream pattern de d3
4. G√®re automatiquement le clipping et le positionnement

**Caract√©ristiques :**
- Compatible avec d3 et Observable Plot
- Supporte `.scale()`, `.translate()`, `.stream()`
- Utilise le pattern multiplex pour fusionner les streams

#### `generateProjectionCode()`

G√©n√®re le code TypeScript source complet.

**Retour :** String contenant :
- Imports n√©cessaires (`d3-geo`)
- Fonction factory de projection
- D√©clarations des projections par territoire
- Logique de multiplex stream
- M√©thodes `.scale()`, `.translate()`, `.stream()`

**Format du code g√©n√©r√© :**
```typescript
import type { GeoProjection } from 'd3-geo'
import { geoConicConformal, geoMercator } from 'd3-geo'

export default function customCompositeProjection(): GeoProjection {
  // ... impl√©mentation compl√®te
  return (projection as any).scale(2700)
}
```

#### `exportConfigAsJSON()`

Exporte la configuration en JSON pour persistence ou import.

**Utilit√© :**
- Sauvegarde de configurations
- Import/export entre sessions
- Versionnement des configurations
- Partage entre utilisateurs

### 2. Composants

#### `ProjectionExporter.vue`

**Responsabilit√©s :**
- Bouton d'export visible dans l'UI
- Modal avec s√©lection de format (TypeScript/JSON)
- Aper√ßu du code g√©n√©r√© avec coloration syntaxique
- Actions : Copier dans le presse-papier / T√©l√©charger fichier
- Notifications toast (succ√®s/erreur)

**Props expos√©es :**
```typescript
defineExpose({
  customProjection, // Instance de projection pour preview
  openExportModal, // Fonction pour ouvrir le modal
})
```

**State :**
- `exportFormat`: `'typescript' | 'json'`
- `isModalOpen`: `boolean`
- `notification`: Toast message state

#### `ProjectionPreview.vue`

**Responsabilit√©s :**
- Afficher un aper√ßu de la projection g√©n√©r√©e
- Rendu avec Observable Plot
- Mise √† jour temps r√©el quand la projection change

**Props :**
```typescript
{
  projection: () => GeoProjection  // Factory function
  title?: string
}
```

**Comportement :**
- Watch sur les donn√©es g√©o et la projection
- Re-render automatique
- √âtat de chargement avec spinner

### 3. Utilitaire de rendu (`utils/plotHelper.ts`)

#### `plotCartography()`

Fonction helper pour cr√©er un plot Observable Plot avec une projection personnalis√©e.

**Signature :**
```typescript
function plotCartography(
  geoData: GeoJSON.FeatureCollection,
  regions: Array<{ name: string, code: string }>,
  projection: GeoProjection
): HTMLElement | SVGSVGElement
```

**Utilit√© :**
- Simplifie le rendu des projections
- G√®re les tooltips et les couleurs
- R√©utilisable dans diff√©rents composants

## Workflow utilisateur

### √âtape 1 : Configuration visuelle

```
Utilisateur dans l'onglet "Vue unifi√©e personnalisable"
    ‚Üì
Ajuste les sliders de translation X/Y pour FR-GF (Guyane)
    ‚Üì
Ajuste le slider de scale pour FR-GF
    ‚Üì
Voit la carte se mettre √† jour en temps r√©el
```

### √âtape 2 : Export

```
Clique sur "üó∫Ô∏è Exporter la projection"
    ‚Üì
Modal s'ouvre avec 2 formats disponibles
    ‚Üì
S√©lectionne TypeScript (.ts)
    ‚Üì
Voit le code g√©n√©r√© dans l'aper√ßu
    ‚Üì
Clique sur "üìã Copier" ou "üíæ T√©l√©charger"
```

### √âtape 3 : Utilisation

```typescript
// 1. Copier le code dans src/services/MyCustomProjection.ts

// 2. Importer et utiliser
import myCustomProjection from './MyCustomProjection'

const projection = myCustomProjection()

// 3. Utiliser avec Observable Plot
const plot = Plot.plot({
  projection,
  marks: [
    Plot.geo(franceData, {
      fill: 'region',
      stroke: 'white'
    })
  ]
})

// 4. Ou avec d3 directement
const path = d3.geoPath(projection)
svg.append('path')
  .datum(franceData)
  .attr('d', path)
```

## Correspondance des param√®tres

### Valeurs par d√©faut des territoires

Bas√©es sur `ConicConformalFrance.ts` :

| Territoire | Code | translateXCoeff | translateYCoeff | scaleMultiplier | clipExtent |
|------------|------|-----------------|-----------------|-----------------|------------|
| Guyane | FR-GF | -0.12 | 0.0575 | 0.6 | `{x1: -0.14, y1: 0.029, x2: -0.0996, y2: 0.0864}` |
| Martinique | FR-MQ | -0.12 | 0.012 | 0.6 | `{x1: -0.14, y1: 0, x2: -0.0996, y2: 0.029}` |
| Guadeloupe | FR-GP | -0.12 | -0.016 | 0.6 | `{x1: -0.14, y1: -0.032, x2: -0.0996, y2: 0}` |
| Mayotte | FR-YT | 0.1167 | -0.064 | 0.6 | `{x1: 0.0967, y1: -0.076, x2: 0.1371, y2: -0.052}` |
| R√©union | FR-RE | 0.1167 | -0.036 | 0.6 | `{x1: 0.0967, y1: -0.052, x2: 0.1371, y2: -0.02}` |
| Nouvelle-Cal√©donie | FR-NC | 0.1167 | -0.004 | 0.6 | `{x1: 0.0967, y1: -0.02, x2: 0.1371, y2: 0.012}` |
| Wallis-et-Futuna | FR-WF | 0.1167 | 0.0225 | 0.6 | `{x1: 0.0967, y1: 0.012, x2: 0.1371, y2: 0.033}` |
| Polyn√©sie fran√ßaise | FR-PF | 0.1167 | 0.0598 | 0.6 | `{x1: 0.0967, y1: 0.033, x2: 0.1371, y2: 0.0864}` |
| Saint-Pierre-et-Miquelon | FR-PM | -0.12 | -0.064 | 0.6 | `{x1: -0.14, y1: -0.076, x2: -0.0996, y2: -0.052}` |
| Saint-Martin | FR-MF | -0.12 | -0.042 | 0.6 | `{x1: -0.14, y1: -0.052, x2: -0.0996, y2: -0.032}` |
| Terres australes | FR-TF | 0.1167 | -0.083 | 0.6 | `{x1: 0.0967, y1: -0.09, x2: 0.1371, y2: -0.076}` |

### Formule de conversion

```typescript
// UI slider value ‚Üí Projection coefficient
const uiTranslateX = -15 to +15  // Slider range
const uiTranslateY = -10 to +10  // Slider range
const uiScale = 0.5 to 2.0       // Scale slider

// Conversion factor (empirique, ajustable)
const CONVERSION_FACTOR = 0.008

// Result
const translateXCoeff = uiTranslateX * CONVERSION_FACTOR
const translateYCoeff = uiTranslateY * CONVERSION_FACTOR
const scaleMultiplier = uiScale

// Dans la projection (k = scale de base, ex: 2700)
projection.translate([
  x + translateXCoeff * k,
  y + translateYCoeff * k
])
projection.scale(baseScale * scaleMultiplier)
```

## Multiplex Stream Pattern

Le syst√®me utilise le pattern multiplex de d3 pour fusionner plusieurs projections :

```typescript
function multiplex(streams: any[]) {
  const n = streams.length
  return {
    point(x: number, y: number) {
      for (let i = 0; i < n; i++) streams[i].point(x, y)
    },
    sphere() { /* ... */ },
    lineStart() { /* ... */ },
    lineEnd() { /* ... */ },
    polygonStart() { /* ... */ },
    polygonEnd() { /* ... */ }
  }
}

// Utilisation
projection.stream = function (stream) {
  return cache && cacheStream === stream
    ? cache
    : (cache = multiplex([
        europe.stream(cacheStream = stream),
        guyane.stream(stream),
        martinique.stream(stream),
        // ... autres territoires
      ]))
}
```

**Avantage :** Chaque territoire a sa propre projection et clip extent, mais le rendu est unifi√©.

## Tests et validation

### Checklist de validation

- [ ] Les sliders modifient la carte en temps r√©el
- [ ] Le bouton d'export ouvre le modal
- [ ] Le code TypeScript g√©n√©r√© est syntaxiquement valide
- [ ] Le code peut √™tre copi√© dans le presse-papier
- [ ] Le fichier peut √™tre t√©l√©charg√©
- [ ] Le JSON export√© contient toutes les configurations
- [ ] L'aper√ßu de projection se met √† jour avec les changements
- [ ] La notification toast appara√Æt apr√®s copie
- [ ] Le code g√©n√©r√© peut √™tre import√© et utilis√©

### Exemple de test manuel

1. Ouvrir l'application ‚Üí onglet "Vue unifi√©e personnalisable"
2. Ajuster Guyane : X = +5, Y = -3, Scale = 1.2
3. Cliquer "Exporter la projection"
4. S√©lectionner TypeScript
5. V√©rifier que le code contient :
   ```typescript
   // Guyane
   const guyane = geoMercator()
     .center([-53.2, 3.9])
   ```
   Et les valeurs de translate/scale correspondantes
6. Copier le code
7. Cr√©er un fichier `test-projection.ts`
8. Coller et v√©rifier la compilation TypeScript

## √âvolutions futures

### Fonctionnalit√©s √† ajouter

1. **Import de configuration JSON**
   - Charger une configuration sauvegard√©e
   - Appliquer aux sliders
   - Mettre √† jour la carte

2. **Presets**
   - Configurations pr√©-d√©finies (ex: "Guyane mise en avant", "Oc√©an Indien focus")
   - Galerie de presets communautaires

3. **Comparaison c√¥te √† c√¥te**
   - Afficher 2 projections simultan√©ment
   - Avant/apr√®s les modifications

4. **Animation de transition**
   - Animer le passage d'une configuration √† une autre
   - Export en GIF ou vid√©o

5. **Param√®tres avanc√©s**
   - Modifier les clip extents
   - Changer les centres g√©ographiques
   - Ajuster les parallels de la projection de base

6. **Partage**
   - G√©n√©rer une URL avec configuration encod√©e
   - Partage social
   - Export vers Observable Notebook

## R√©f√©rences

- [d3-geo documentation](https://github.com/d3/d3-geo)
- [d3-composite-projections](https://github.com/rveciana/d3-composite-projections)
- [Observable Plot projections](https://observablehq.com/plot/features/projections)
- [GeoJSON specification](https://geojson.org/)

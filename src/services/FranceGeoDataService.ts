export interface Territory {
  name: string
  code: string
  area: number
  data?: any
  repositioned?: any
}

export class FranceGeoDataService {
  private metropoleData: any = null
  private domtomData: Territory[] = []
  private territoryInfo: Territory[] = []

  async loadAllData() {
    console.log('üì° Chargement des donn√©es g√©ographiques...')
    
    // Pour l'instant, on utilise des donn√©es de d√©monstration
    // Dans un vrai projet, on chargerait depuis des fichiers TopoJSON/GeoJSON
    await this.loadDemoData()
    
    console.log('‚úÖ Donn√©es g√©ographiques charg√©es')
  }

  private async loadDemoData() {
    // Cr√©er des donn√©es de d√©monstration pour la France m√©tropolitaine
    this.metropoleData = this.createDemoMetropoleData()
    
    // Cr√©er des donn√©es de d√©monstration pour les DOM-TOM
    this.domtomData = this.createDemoDOMTOMData()
    
    // Informations sur les territoires
    this.territoryInfo = [
      { name: 'France m√©tropolitaine', code: 'FR-MET', area: 543965 },
      { name: 'Guadeloupe', code: 'FR-GP', area: 1628 },
      { name: 'Martinique', code: 'FR-MQ', area: 1128 },
      { name: 'Guyane', code: 'FR-GF', area: 83534 },
      { name: 'La R√©union', code: 'FR-RE', area: 2512 },
      { name: 'Mayotte', code: 'FR-YT', area: 374 },
      { name: 'Saint-Pierre-et-Miquelon', code: 'FR-PM', area: 242 },
      { name: 'Wallis-et-Futuna', code: 'FR-WF', area: 142 },
      { name: 'Polyn√©sie fran√ßaise', code: 'FR-PF', area: 4167 },
      { name: 'Nouvelle-Cal√©donie', code: 'FR-NC', area: 18575 }
    ]
  }

  private createDemoMetropoleData() {
    // Contour approximatif de la France m√©tropolitaine
    return {
      type: 'FeatureCollection',
      features: [{
        type: 'Feature',
        properties: { name: 'France m√©tropolitaine' },
        geometry: {
          type: 'Polygon',
          coordinates: [[
            [-4.5, 48.4], // Bretagne
            [8, 48.8],    // Alsace
            [7.5, 43.2],  // C√¥te d'Azur
            [3, 42.3],    // Pyr√©n√©es
            [-1.8, 43.2], // Pays Basque
            [-4.5, 48.4]  // Retour Bretagne
          ]]
        }
      }]
    }
  }

  private createDemoDOMTOMData(): Territory[] {
    return [
      {
        name: 'Guadeloupe',
        code: 'GP',
        area: 1628,
        data: this.createTerritoryGeoJSON('Guadeloupe', [[-61.8, 16.3], [-61.0, 16.3], [-61.0, 15.8], [-61.8, 15.8], [-61.8, 16.3]])
      },
      {
        name: 'Martinique', 
        code: 'MQ',
        area: 1128,
        data: this.createTerritoryGeoJSON('Martinique', [[-61.2, 14.9], [-60.8, 14.9], [-60.8, 14.4], [-61.2, 14.4], [-61.2, 14.9]])
      },
      {
        name: 'Guyane',
        code: 'GF', 
        area: 83534,
        data: this.createTerritoryGeoJSON('Guyane', [[-54.6, 5.7], [-51.6, 5.7], [-51.6, 2.1], [-54.6, 2.1], [-54.6, 5.7]])
      },
      {
        name: 'La R√©union',
        code: 'RE',
        area: 2512,
        data: this.createTerritoryGeoJSON('La R√©union', [[55.2, -20.9], [55.8, -20.9], [55.8, -21.4], [55.2, -21.4], [55.2, -20.9]])
      },
      {
        name: 'Mayotte',
        code: 'YT',
        area: 374,
        data: this.createTerritoryGeoJSON('Mayotte', [[45.0, -12.7], [45.3, -12.7], [45.3, -13.0], [45.0, -13.0], [45.0, -12.7]])
      },
      {
        name: 'Nouvelle-Cal√©donie',
        code: 'NC',
        area: 18575,
        data: this.createTerritoryGeoJSON('Nouvelle-Cal√©donie', [[164.0, -19.0], [167.0, -19.0], [167.0, -23.0], [164.0, -23.0], [164.0, -19.0]])
      }
    ]
  }

  private createTerritoryGeoJSON(name: string, coordinates: number[][]) {
    return {
      type: 'FeatureCollection',
      features: [{
        type: 'Feature',
        properties: { name },
        geometry: {
          type: 'Polygon',
          coordinates: [coordinates]
        }
      }]
    }
  }

  async getMetropoleData() {
    return this.metropoleData
  }

  async getDOMTOMData(): Promise<Territory[]> {
    return this.domtomData
  }

  async getUnifiedData() {
    // Cr√©er une vue unifi√©e avec repositionnement des DOM-TOM
    const repositionedDOMTOM = this.domtomData.map((territory, index) => {
      const repositioned = this.repositionTerritory(territory, index)
      return {
        ...territory,
        repositioned
      }
    })

    return {
      metropole: this.metropoleData,
      domtom: repositionedDOMTOM
    }
  }

  private repositionTerritory(territory: Territory, index: number) {
    // Repositionner les DOM-TOM √† c√¥t√© de la m√©tropole
    // Calculer une position √† droite ou en bas de la France
    const offsetX = 10 + (index % 3) * 8  // D√©calage horizontal
    const offsetY = 45 + Math.floor(index / 3) * 8  // D√©calage vertical
    
    if (!territory.data || !territory.data.features) return territory.data

    // D√©placer les coordonn√©es
    const repositioned = JSON.parse(JSON.stringify(territory.data))
    repositioned.features.forEach((feature: any) => {
      if (feature.geometry && feature.geometry.coordinates) {
        this.transformCoordinates(feature.geometry.coordinates, offsetX, offsetY)
      }
    })

    return repositioned
  }

  private transformCoordinates(coordinates: any, offsetX: number, offsetY: number) {
    if (Array.isArray(coordinates[0])) {
      coordinates.forEach((coord: any) => {
        this.transformCoordinates(coord, offsetX, offsetY)
      })
    } else {
      coordinates[0] += offsetX
      coordinates[1] = offsetY
    }
  }

  getTerritoryInfo(): Territory[] {
    return this.territoryInfo
  }
}
#!/usr/bin/env node

/**
 * Script de diagnostic des donn√©es g√©ographiques
 */

import fs from 'fs/promises'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
const dataDir = path.join(__dirname, '../public/data')

async function diagnosisData() {
  try {
    console.log('üîç Diagnostic des donn√©es g√©ographiques\n')
    
    // V√©rifier les fichiers
    const francePath = path.join(dataDir, 'france-territories.json')
    const metaPath = path.join(dataDir, 'metadata.json')
    
    const franceData = JSON.parse(await fs.readFile(francePath, 'utf-8'))
    const metaData = JSON.parse(await fs.readFile(metaPath, 'utf-8'))
    
    console.log('üìä M√©tadonn√©es:')
    console.log(`   Source: ${metaData.source} v${metaData.version}`)
    console.log(`   Territoires: ${metaData.territories.length}`)
    metaData.territories.forEach(t => {
      console.log(`     ‚Ä¢ ${t.name} (${t.code}) - ${t.area.toLocaleString()} km¬≤`)
    })
    
    console.log('\nüó∫Ô∏è Donn√©es TopoJSON:')
    console.log(`   Type: ${franceData.type}`)
    console.log(`   Arcs: ${franceData.arcs ? franceData.arcs.length : 'N/A'}`)
    console.log(`   Objets: ${Object.keys(franceData.objects).join(', ')}`)
    
    if (franceData.objects.territories) {
      const territories = franceData.objects.territories.geometries || []
      console.log(`   Geometries: ${territories.length}`)
      
      territories.forEach((geom, i) => {
        console.log(`     ${i+1}. ID: ${geom.id}, Type: ${geom.type}, Nom: ${geom.properties?.name || 'N/A'}`)
        
        // V√©rifier les coordonn√©es
        if (geom.arcs) {
          console.log(`        Arcs: ${geom.arcs.length} groupe(s)`)
        }
      })
    }
    
    // V√©rifier la coh√©rence
    const metaCount = metaData.territories.length
    const geomCount = franceData.objects.territories?.geometries?.length || 0
    
    console.log('\n‚úÖ V√©rifications:')
    console.log(`   M√©tadonn√©es: ${metaCount} territoires`)
    console.log(`   G√©om√©tries: ${geomCount} features`)
    
    if (metaCount === geomCount) {
      console.log('   ‚úÖ Coh√©rence OK')
    } else {
      console.log('   ‚ö†Ô∏è Incoh√©rence d√©tect√©e!')
    }
    
  } catch (error) {
    console.error('‚ùå Erreur diagnostic:', error.message)
  }
}

diagnosisData()